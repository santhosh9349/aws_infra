name: Terraform Drift Detection

on:
  schedule:
    # Run at 8:00 AM UTC (9:00 AM BST during summer)
    - cron: '0 8 * * *'
  
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to check for drift'
        required: true
        default: 'dev4'
        type: choice
        options:
          - dev
          - prod

env:
  TF_VERSION: '1.5.7'
  AWS_REGION: 'eu-west-2'

jobs:
  drift-detection:
    name: Detect Terraform Drift
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    permissions:
      id-token: write    # Required for OIDC authentication
      contents: read     # Required for checkout
      issues: write      # Required for creating issues
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::017373135945:role/github_oidc_drift
          role-session-name: DriftDetectionSession
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}
          terraform_wrapper: false

      - name: Terraform Init
        id: init
        working-directory: terraform/${{ github.event.inputs.environment || 'dev' }}
        run: terraform init -input=false

      - name: Terraform Plan (Drift Detection)
        id: plan
        working-directory: terraform/${{ github.event.inputs.environment || 'dev' }}
        run: |
          set +e
          MAX_RETRIES=2
          RETRY_DELAY=300  # 5 minutes
          
          for attempt in $(seq 1 $MAX_RETRIES); do
            echo "ðŸ”„ Terraform plan attempt $attempt of $MAX_RETRIES"
            
            # Note: Terraform Cloud doesn't support -out flag, so we just detect changes
            terraform plan -detailed-exitcode -input=false 2>&1 | tee /tmp/plan_output.txt
            EXIT_CODE=${PIPESTATUS[0]}
            
            # Check for state lock error
            if grep -q "Error acquiring the state lock\|Error locking state\|Lock Info:" /tmp/plan_output.txt; then
              if [ $attempt -lt $MAX_RETRIES ]; then
                echo "â³ State lock detected, waiting ${RETRY_DELAY}s before retry..."
                sleep $RETRY_DELAY
                continue
              else
                echo "âŒ State lock persisted after $MAX_RETRIES attempts"
                exit 1
              fi
            fi
            
            # Process exit code (only reached if no lock error)
            break
          done
          
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          
          # Save plan output for later use
          cp /tmp/plan_output.txt ${{ github.workspace }}/plan_output.txt
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "âœ… No drift detected - infrastructure matches Terraform state"
            echo "drift_detected=false" >> $GITHUB_OUTPUT
          elif [ $EXIT_CODE -eq 1 ]; then
            echo "âŒ Terraform plan failed with an error"
            exit 1
          elif [ $EXIT_CODE -eq 2 ]; then
            echo "âš ï¸ Drift detected - infrastructure differs from Terraform state"
            echo "drift_detected=true" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Check for plan errors
        if: steps.plan.outputs.exit_code == '1'
        run: |
          echo "::error::Terraform plan failed. Check the logs above for details."
          exit 1

      - name: Parse drift from plan output
        id: parse
        if: steps.plan.outputs.drift_detected == 'true'
        run: |
          # Parse the plan text output to identify changed resources
          echo "Parsing drift from plan output..."
          
          # Extract resource changes from plan output
          grep -E "^  # .* (will be|must be)" ${{ github.workspace }}/plan_output.txt > /tmp/drift_resources.txt || true
          
          # Count changes
          CREATE_COUNT=$(grep -c "will be created" /tmp/drift_resources.txt 2>/dev/null || echo "0")
          UPDATE_COUNT=$(grep -c "will be updated" /tmp/drift_resources.txt 2>/dev/null || echo "0")
          DELETE_COUNT=$(grep -c "will be destroyed" /tmp/drift_resources.txt 2>/dev/null || echo "0")
          REPLACE_COUNT=$(grep -c "must be replaced" /tmp/drift_resources.txt 2>/dev/null || echo "0")
          
          echo "create_count=$CREATE_COUNT" >> $GITHUB_OUTPUT
          echo "update_count=$UPDATE_COUNT" >> $GITHUB_OUTPUT
          echo "delete_count=$DELETE_COUNT" >> $GITHUB_OUTPUT
          echo "replace_count=$REPLACE_COUNT" >> $GITHUB_OUTPUT
          
          TOTAL_COUNT=$((CREATE_COUNT + UPDATE_COUNT + DELETE_COUNT + REPLACE_COUNT))
          echo "total_count=$TOTAL_COUNT" >> $GITHUB_OUTPUT
          
          echo "ðŸ“Š Drift summary: $CREATE_COUNT creates, $UPDATE_COUNT updates, $DELETE_COUNT deletes, $REPLACE_COUNT replaces"

      - name: Query CloudTrail for attribution
        id: cloudtrail
        if: steps.plan.outputs.drift_detected == 'true'
        run: |
          if [ -f scripts/drift-detection/query-cloudtrail.sh ]; then
            chmod +x scripts/drift-detection/query-cloudtrail.sh
            scripts/drift-detection/query-cloudtrail.sh || true
          else
            echo "CloudTrail query script not found, skipping attribution"
          fi

      - name: Generate issue body
        id: issue_body
        if: steps.plan.outputs.drift_detected == 'true'
        env:
          ENVIRONMENT: ${{ github.event.inputs.environment || 'dev' }}
          RUN_ID: ${{ github.run_id }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          CREATE_COUNT: ${{ steps.parse.outputs.create_count }}
          UPDATE_COUNT: ${{ steps.parse.outputs.update_count }}
          DELETE_COUNT: ${{ steps.parse.outputs.delete_count }}
          REPLACE_COUNT: ${{ steps.parse.outputs.replace_count }}
          TOTAL_COUNT: ${{ steps.parse.outputs.total_count }}
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          # Get plan text output (truncated)
          PLAN_OUTPUT=$(head -200 ${{ github.workspace }}/plan_output.txt)
          
          # Create issue body
          cat > /tmp/issue_body.md << EOF
          ## Drift Detection Report

          | Field | Value |
          |-------|-------|
          | **Environment** | ${ENVIRONMENT} |
          | **Detected At** | ${TIMESTAMP} |
          | **Workflow Run** | [${RUN_ID}](${RUN_URL}) |

          ---

          ### Summary

          | Metric | Count |
          |--------|-------|
          | ðŸ†• Creates | ${CREATE_COUNT} |
          | ðŸ“ Updates | ${UPDATE_COUNT} |
          | ðŸ—‘ï¸ Deletes | ${DELETE_COUNT} |
          | ðŸ”„ Replaces | ${REPLACE_COUNT} |
          | **Total** | **${TOTAL_COUNT}** |

          ---

          ### Terraform Plan Output

          <details>
          <summary>Click to expand full plan output</summary>

          \`\`\`hcl
          ${PLAN_OUTPUT}
          \`\`\`

          </details>

          ---

          ### Remediation Options

          #### Option 1: Accept Drift (Update Terraform)
          \`\`\`bash
          cd terraform/${ENVIRONMENT}
          terraform plan
          \`\`\`

          #### Option 2: Revert Drift (Apply Terraform)
          \`\`\`bash
          cd terraform/${ENVIRONMENT}
          terraform apply
          \`\`\`

          ---

          *This issue was automatically created by the [drift detection workflow](${RUN_URL}).*
          EOF
          
          echo "Issue body generated"

      - name: Create GitHub Issue
        id: create_issue
        if: steps.plan.outputs.drift_detected == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ENVIRONMENT: ${{ github.event.inputs.environment || 'dev' }}
        run: |
          DATE=$(date -u +"%Y-%m-%d")
          ISSUE_URL=$(gh issue create \
            --title "ðŸ”´ Terraform Drift Detected - ${ENVIRONMENT} - ${DATE}" \
            --body-file /tmp/issue_body.md \
            --label "drift,infrastructure,automated,${ENVIRONMENT}")
          
          echo "issue_url=$ISSUE_URL" >> $GITHUB_OUTPUT
          echo "âœ… Created issue: $ISSUE_URL"

      - name: Send Teams notification
        if: steps.plan.outputs.drift_detected == 'true' && steps.create_issue.outputs.issue_url != ''
        env:
          TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}
          ISSUE_URL: ${{ steps.create_issue.outputs.issue_url }}
          ENVIRONMENT: ${{ github.event.inputs.environment || 'dev' }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          chmod +x scripts/drift-detection/format-teams-card.sh
          
          # Generate Teams card JSON
          TEAMS_PAYLOAD=$(scripts/drift-detection/format-teams-card.sh)
          
          # Send to Teams
          RESPONSE=$(curl -s -w "%{http_code}" -o /tmp/teams_response.txt \
            -H "Content-Type: application/json" \
            -d "$TEAMS_PAYLOAD" \
            "$TEAMS_WEBHOOK_URL")
          
          if [ "$RESPONSE" = "200" ] || [ "$RESPONSE" = "202" ]; then
            echo "âœ… Teams notification sent successfully"
          else
            echo "âš ï¸ Teams notification failed with status $RESPONSE"
            cat /tmp/teams_response.txt
            # Don't fail the workflow for notification failures
          fi

      - name: Workflow Summary
        run: |
          if [ "${{ steps.plan.outputs.drift_detected }}" = "true" ]; then
            echo "## âš ï¸ Drift Detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Infrastructure drift was detected in the **${{ github.event.inputs.environment || 'dev' }}** environment." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“‹ **Issue Created**: ${{ steps.create_issue.outputs.issue_url }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âœ… No Drift Detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Infrastructure in **${{ github.event.inputs.environment || 'dev' }}** matches the Terraform state." >> $GITHUB_STEP_SUMMARY
          fi

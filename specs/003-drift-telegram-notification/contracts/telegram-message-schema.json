{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://github.com/aws_infra/schemas/telegram-message.json",
  "title": "Telegram Drift Notification Message",
  "description": "Schema for Telegram messages sent when infrastructure drift is detected",
  "type": "object",
  "required": ["version", "notification_type", "metadata", "content"],
  "properties": {
    "version": {
      "type": "string",
      "description": "Message schema version",
      "const": "1.0.0"
    },
    "notification_type": {
      "type": "string",
      "description": "Type of notification",
      "enum": ["drift_alert", "drift_summary"]
    },
    "metadata": {
      "type": "object",
      "description": "Notification metadata",
      "required": ["timestamp", "environment", "workflow_run_url"],
      "properties": {
        "timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "ISO 8601 timestamp when drift was detected"
        },
        "environment": {
          "type": "string",
          "description": "Target environment",
          "enum": ["dev", "staging", "prod"]
        },
        "branch": {
          "type": "string",
          "description": "Git branch where detection ran"
        },
        "workflow_run_id": {
          "type": "string",
          "description": "GitHub Actions run ID"
        },
        "workflow_run_url": {
          "type": "string",
          "format": "uri",
          "description": "URL to view full workflow run details"
        }
      }
    },
    "content": {
      "type": "object",
      "description": "Message content",
      "required": ["drift_detected", "total_changes", "formatted_message"],
      "properties": {
        "drift_detected": {
          "type": "boolean",
          "description": "Whether any drift was found"
        },
        "total_changes": {
          "type": "integer",
          "minimum": 0,
          "description": "Total number of resource changes detected"
        },
        "changes_by_action": {
          "type": "object",
          "description": "Resource changes grouped by action type",
          "properties": {
            "create": {"type": "integer", "minimum": 0},
            "update": {"type": "integer", "minimum": 0},
            "delete": {"type": "integer", "minimum": 0},
            "replace": {"type": "integer", "minimum": 0}
          }
        },
        "resource_changes": {
          "type": "array",
          "description": "Detailed list of resource changes",
          "items": {
            "type": "object",
            "required": ["resource_type", "resource_name", "action"],
            "properties": {
              "resource_type": {
                "type": "string",
                "description": "AWS resource type (e.g., aws_instance)"
              },
              "resource_name": {
                "type": "string",
                "description": "Resource name in Terraform"
              },
              "action": {
                "type": "string",
                "enum": ["create", "update", "delete", "replace", "no-op"]
              },
              "change_summary": {
                "type": "array",
                "description": "List of changed attributes",
                "items": {"type": "string"}
              }
            }
          }
        },
        "formatted_message": {
          "type": "string",
          "maxLength": 4096,
          "description": "Pre-formatted Telegram message in MarkdownV2 format"
        },
        "part_info": {
          "type": "object",
          "description": "Message part information for split messages",
          "required": ["part_number", "total_parts"],
          "properties": {
            "part_number": {
              "type": "integer",
              "minimum": 1
            },
            "total_parts": {
              "type": "integer",
              "minimum": 1
            }
          }
        }
      }
    }
  },
  "examples": [
    {
      "version": "1.0.0",
      "notification_type": "drift_alert",
      "metadata": {
        "timestamp": "2026-01-29T14:30:00Z",
        "environment": "dev",
        "branch": "main",
        "workflow_run_id": "12345678",
        "workflow_run_url": "https://github.com/org/aws_infra/actions/runs/12345678"
      },
      "content": {
        "drift_detected": true,
        "total_changes": 2,
        "changes_by_action": {
          "update": 1,
          "create": 1
        },
        "resource_changes": [
          {
            "resource_type": "aws_instance",
            "resource_name": "web_server",
            "action": "update",
            "change_summary": [
              "instance_type: t2.micro ‚Üí t2.small"
            ]
          },
          {
            "resource_type": "aws_security_group",
            "resource_name": "allow_https",
            "action": "create",
            "change_summary": [
              "Action: create"
            ]
          }
        ],
        "formatted_message": "üö® **Infrastructure Drift Detected**\n\n**Environment**: dev\n**Time**: 2026-01-29 14:30:00 UTC\n**Resources Affected**: 2\n\n**Changes**:\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüì¶ aws_instance.web_server\n  ‚Ä¢ instance_type: t2.micro ‚Üí t2.small\n\nüÜï aws_security_group.allow_https\n  ‚Ä¢ Action: create\n\n[View Full Report](https://github.com/org/aws_infra/actions/runs/12345678)",
        "part_info": {
          "part_number": 1,
          "total_parts": 1
        }
      }
    }
  ]
}
